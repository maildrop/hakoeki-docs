# 映像配信サーバーの構築手順

## 忠告
この解説では、全ての操作をLinuxのCUI上で行います。
テキストファイルの編集や、プログラムのインストールなども全てCUI上で行います。
そのため、Linuxの基本的なコマンドをある程度把握していないと、作業が厳しくなります。
映像配信サーバーの構築を行う前に、Linux上でテキストファイルの編集ができる程度に勉強しておくと、作業がスムーズに進むと思います。

勉強方法ですが、Googleで「Linux とは」や「Linux 基本 コマンド」などと調べると、解説記事が大量に見つかります。
見つかったサイトであらかじめ予備知識を蓄えておくことをおすすめします。
テキスト編集を行うソフトは何でもよいですが、最初は`nano`がおすすめです。他には`vim`や`emacs`などがあります。
この解説では`vim`を用いてテキストを編集しますが、それぞれ好きなエディタに置き換えてテキストを編集してください。

## 概要
映像を配信するためのサーバーを構築する手順を解説します。
構築手順を説明する前に、使用するOSとプログラムを説明します。

### OS
サーバーのOSには`Ubuntu 18.04 (64bit)`を用います。
UbuntuはLinuxディストリビューションの1つです。
また、ここではOSを動かすためにConoha VPSでサーバーをレンタルしました。
VPSのプランは`CPU 1Core`　`SSD 30GB`を使用しました。
  
補足ですが、Conoha VPSはレンタル料金が1時間単位で計算されるので、ちょっとしたLinux環境の用意に適しています。
また、OSのインストールも1分ほどで終了するので、仮に実行環境を汚してしまっても、すぐにOSを再インストールし、気軽にやり直すことができます。

### 映像配信サーバー
映像配信サーバーには`nginx-rtmp-module`を用います。
これはrtmp形式の配信サーバーを`nginx`のプラグインという形で起動させることができるプログラムです。
`nginx`とは、webサーバーの1つです。

### VPNサーバー
VPNサーバーの構築には`swanctl`を用います。
このサーバーは無くても動作はしますが、セキュリティ強化のために立てておきます。
これを使用することにより、ネットワークの全ての通信、もしくは一部の通信を暗号化するすることができます。
今回の手法では、映像データの通信は暗号化されないため、ネットワークの通信経路に傍受者がいた場合、映像が流出することになります。
これを防ぐため、面倒ではありますが、VPNサーバーの構築も行うことにしました。

### DDNSサーバー
DDNSサーバーの構築には`bind9`を用います。
このサーバーも無くても動作はしますが、作業効率を上げるために立てておきます。
VPNサーバーにアクセスしたコンピューターにはそれぞれ、`10.0.0.103`のようなローカルIPアドレスが割り振られます。
しかし、そのIPアドレスは(多分)接続するたびに変動します。
これは不便であるため、コンピューターごとに固定のアドレスを指定したかったのですが、設定項目を見つけるとこができませんでした。
そこで、代替案としてDDNSサーバーを構築することにしました。
DDNSサーバーを構築すると、VPNサーバーに接続するコンピュータごとに固定のドメイン名を割り振ることができます。
たとえば`10.0.0.103`のアドレスの代わりに、`yamada.hakoeki`といったドメイン名でアクセスできるようになります。

### WEBサーバー
WEBサーバーには`nginx`と`nodejs`の2つを用います。
`nginx`は映像配信サーバーである`nginx-rtmp-module`を動作させるために必要です。
また、ブラウザから配信の録画ファイルをダウンロードできるようにするためにも使用します。
`nodejs`はWEBサーバーではなく、`javascript`の実行環境です。
`javascript`を用いてWEBサーバーを構築し、映像配信の一覧をブラウザから確認できるようにするために使用します。

